<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test</title>

    <script>
        const STORAGE_TOKEN = 'I6UE37M81WPHG1CYOP17O5XNIFP9VCIPG0GVDZE8';
        const URL = 'https://remote-storage.developerakademie.org/item';

        async function setItem(key, value) {
            const payload = { key, value, token: STORAGE_TOKEN };
            return fetch(URL, { method: 'POST', body: JSON.stringify(payload) }).then(res => res.json());
        }

        async function getItem(key) {
            const url = `${URL}?key=${key}&token=${STORAGE_TOKEN}`;
            return fetch(url).then(res => res.json());
        }

        async function setTest(event) {
            event.preventDefault(); // Verhindert die Standardaktion des Formulars

            const key = 'test';
            const nameInput = document.getElementById('name');
            const mailInput = document.getElementById('mail');
            const phoneInput = document.getElementById('phone');

            // HTML5-Validierung
            if (nameInput.checkValidity() && mailInput.checkValidity() && phoneInput.checkValidity()) {
                const name = nameInput.value;
                const mail = mailInput.value;
                const phone = phoneInput.value;

                // Zusätzliche Validierung für E-Mail und Telefonnummer
                if (isValidEmail(mail) && isValidPhoneNumber(phone)) {
                    const newData = {
                        'name': name,
                        'mail': mail,
                        'phone': phone
                    };

                    try {
                        // Zuerst die vorhandenen Daten abrufen
                        const existingData = await getItem(key);

                        let dataToUpdate = [];

                        // Überprüfen, ob bereits Daten vorhanden sind
                        if (existingData && existingData.data && typeof existingData.data === 'string') {
                            // Falls vorhanden, die Daten parsen
                            const parsedData = JSON.parse(existingData.data);

                            if (parsedData.data && Array.isArray(parsedData.data)) {
                                // Füge die neuen Daten hinzu
                                parsedData.data.push(newData);
                                dataToUpdate = parsedData.data;
                            }
                        } else {
                            // Es gibt noch keine Daten, lege ein neues Array mit den neuen Daten an
                            dataToUpdate.push(newData);
                        }

                        // Die aktualisierte Datenstruktur als Zeichenkette speichern
                        await setItem(key, JSON.stringify({ data: dataToUpdate }));

                        console.log('Daten wurden hinzugefügt:', dataToUpdate);
                    } catch (error) {
                        console.error('Fehler beim Hinzufügen der Daten:', error);
                    }
                } else {
                    console.log('Bitte geben Sie eine gültige E-Mail-Adresse und Telefonnummer ein.');
                }
            } else {
                // Zeige die Browser-integrierte Validierung an
                nameInput.reportValidity();
                mailInput.reportValidity();
                phoneInput.reportValidity();
            }
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+$/;
            return emailRegex.test(email);
        }

        function isValidPhoneNumber(phone) {
            return phone.length >= 5;
        }

    </script>
</head>

<body>
    <form>
        <span>Name</span>
        <input id="name" placeholder="Max Mustermann" autocomplete="off" required>
        <br />
        <span>Mail</span>
        <input id="mail" type="email" placeholder="max@mustermann.de" autocomplete="off" required>
        <br />
        <span>Phone</span>
        <input id="phone" type="tel" placeholder="+49123456789" autocomplete="off" required>
        <br />
        <input id="submit-button" type="submit" value="senden" onclick="setTest(event)">
    </form>
    <br />
    <a href="https://remote-storage.developerakademie.org/item?token=I6UE37M81WPHG1CYOP17O5XNIFP9VCIPG0GVDZE8&key=test">
        remote-storage.developerakademie.org/item?key=test
    </a>
</body>

</html>
